<!DOCTYPE html>
<html>

  <head>
    <style type="text/css">
      body {
        overflow:hidden;
      }
      div{
        text-align:center;
        border:0px solid silver;
        display: table-cell;
        vertical-align:middle;
        color: white;
        background-color: blue;
        font-weight:bold;
        font-family:Verdana, Geneva, sans-serif;
        font-size:20px;
      }
      ul {
        color: white;
      }
    </style>
    <title>Cast Hello Text</title>
  </head>

  <body>
    <h1>SECRET ELON</h1>
    <div id='player-list-div'>
      <h1>Players</h1>
      <ul id="player-list">
      </ul>
    </div>

    <div id='selecting-problem-div'>
      <h1>Someone is creating a problem, how dare they!</h1>
    </div>

    <div id='selecting-elon-div'>
      <h1>Selecting a new personality for Elon Musk!</h1>
    </div>

    <div id='solutions-div'>
      <h1>Solutions! 1+1=Solved World Huger</h1>
      <ul id='solutions-list'>
      </ul>
    </div>

    <div id='voting-div'>
      <h1>Vote! Yay Democracy!</h1>
      <ul id='voting-list'>
      </ul>
    </div>

    <div id='scores-div'>
      <h1>High Scores!</h1>
      <ul id='scores-list'>
      </ul>
    </div>



    <script
  src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"
  crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <script type="text/javascript">

      var gameViews = [
        'PLAYER_LIST',
        'SELECTING_PROBLEM',
        'SELECTING_ELON',
        'DISPLAY_SOLUTIONS',
        'DISPLAY_VOTES',
        'DISPLAY_SCORES'
      ];

      function switchView(toView) {
        $('#player-list-div').hide();
        $('#selecting-problem-div').hide();
        $('#selecting-elon-div').hide();
        $('#solutions-div').hide();
        $('#voting-div').hide();
        $('#scores-div').hide();
        switch (toView) {
          case 'PLAYER_LIST':
            $('#player-list-div').show();
            break;
          case 'SELECTING_PROBLEM':
            $('#selecting-problem-div').show();
            break;
          case 'SELECTING_ELON':
            $('#selecting-elon-div').show();
            break;
          case 'DISPLAY_SOLUTIONS':
            $('#solutions-div').show();
            break;
          case 'DISPLAY_VOTES':
            $('#voting-div').show();
            break;
          case 'DISPLAY_SCORES':
            $('#scores-div').show();
            break;
          default:
            break;
        }
      }

      var baseState = {
        players: [],
        elonSenderId: null,
        problemStatement: null,
        view: ''
      };

      var state = {
        players: [
          // [senderId: null, name: '', score: '', isProblemCreator: true, isElon: false, solution: '']
        ],
        elonSenderId: null,
        problemCreatorSenderId: null,
        problemStatement: ''
      };



      function resetState() {
        state = baseState;
      }

      function resetPlayerState() {
        state.players.forEach(function(player) {
          player['isProblemCreator'] = false;
          player['isElon'] = false;
          player['solution'] = '';
        });
      }

      function senderConnected(senderId) {
        state.players[senderId] = {
          senderId: senderId,
          votedSenderID: null,
          name: '',
          score: 0,
          solution: ''
        };
        $('#player-list').append('<li id="sender-id-'+senderId+'">'+senderId+': <p id="player-name"></p></li>');
      }

      function senderDisconnected(senderId) {
        state.players = state.players.filter(function(player) {return player.senderId !== senderId});
      }

      function nameSubmitted(senderId, name) {
        state.players[senderId].name = name;
        $('li#sender-id-'+senderId+' #player-name').html(JSON.stringify(name));
      }


      function selectProblemCreator() {
        var keys = Object.keys(state.players);
        var randId = Math.floor(Math.rand() * keys.length);
        state.problemCreatorSenderId = keys[randId];
        return state.problemCreatorSenderId;
      }


      function setProblemStatement(problemStatement) {
        state.problemStatement = problemStatement;
      }

      window.onload = function() {
        switchView('PLAYER_LIST');
        var messageURN = 'urn:x-cast:com.connorhenke.elon';

        window.castReceiverContext = cast.framework.CastReceiverContext.getInstance();
        window.castReceiverContext.setLoggerLevel(cast.framework.LoggerLevel.DEBUG);

        window.castReceiverContext.addEventListener(cast.framework.system.EventType.READY, function() {
          resetState();
        });

        // Sender connected
        window.castReceiverContext.addEventListener(cast.framework.system.EventType.SENDER_CONNECTED, function(event) {
          console.log('Sender connected: ' + event.senderId);
          senderConnected(event.senderId);
        });

        // Sender disconnected
        window.castReceiverContext.addEventListener(cast.framework.system.EventType.SENDER_DISCONNECTED, function(event) {
          console.log('Sender disconnected: ' + event.senderId);
          senderDisconnected(event.senderId);
        });

        // Message listener
        window.castReceiverContext.addCustomMessageListener(messageURN, function(event) {
          console.log(event);
          switch (event.data.type) {
            case 'NAME_SUBMITTED':
              nameSubmitted(event.data.senderId, event);
              break;
            case 'START_GAME':
              window.castReceiverContext.sendCustomMessage(messageURN, undefined, {type: 'START_GAME'});
              switchView('SELECTING_PROBLEM');
              var problemCreatorSenderId = selectProblemCreator();
              window.castReceiverContext.sendCustomMessage(messageURN, problemGiverSenderId, {type: 'CHOSEN_PROBLEM_CREATOR'});
              break;
            case 'PROBLEM_SUBMITTED':
              setProblemStatement(event.data.data);

            default:
              break;
          }
        });

        console.log('Starting Receiver Manager');
        window.castReceiverContext.start();
      };
    </script>
  </body>
</html>